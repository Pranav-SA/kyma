apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "loki.fullname" . }}-grafana-stats-dashboard
  labels:
    grafana_dashboard: "1"
    app: {{ template "loki.name" . }}
    chart: {{ template "loki.chart" . }}
    release: {{ .Release.Name }}
data:
  loki-stats-dashboard.json: |- 
      {
        "annotations": {
          "list": [
            {
              "builtIn": 1,
              "datasource": "-- Grafana --",
              "enable": true,
              "hide": true,
              "iconColor": "rgba(0, 211, 255, 1)",
              "name": "Annotations & Alerts",
              "type": "dashboard"
            },
            {
              "datasource": "Loki",
              "enable": true,
              "expr": "{container=\"kube-diff-logger\"} | json | namespace_extracted=\"$namespace\"",
              "hide": true,
              "iconColor": "rgba(255, 96, 96, 1)",
              "name": "deployments",
              "showIn": 0,
              "target": {}
            }
          ]
        },
        "editable": true,
        "gnetId": null,
        "graphTooltip": 1,
        "iteration": 1641804643415,
        "links": [],
        "panels": [
          {
            "aliasColors": {},
            "bars": true,
            "dashLength": 10,
            "dashes": false,
            "datasource": "Prometheus",
            "decimals": 0,
            "fieldConfig": {
              "defaults": {
                "links": []
              },
              "overrides": []
            },
            "fill": 1,
            "fillGradient": 0,
            "gridPos": {
              "h": 5,
              "w": 10,
              "x": 0,
              "y": 0
            },
            "hiddenSeries": false,
            "hideTimeOverride": false,
            "id": 112,
            "legend": {
              "alignAsTable": true,
              "avg": false,
              "current": true,
              "max": false,
              "min": false,
              "rightSide": true,
              "show": true,
              "sideWidth": null,
              "sort": null,
              "sortDesc": null,
              "total": false,
              "values": true
            },
            "lines": false,
            "linewidth": 2,
            "links": [],
            "nullPointMode": "null as zero",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "",
            "pointradius": 5,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "exemplar": true,
                "expr": "count by (namespace) (kube_pod_info{namespace!=\"kube-system\"})",
                "format": "time_series",
                "hide": false,
                "instant": true,
                "interval": "",
                "intervalFactor": 2,
                "legendFormat": "{{`{{namespace}}`}}",
                "refId": "A",
                "step": 10
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeRegions": [],
            "timeShift": null,
            "title": "Active Pods",
            "tooltip": {
              "shared": false,
              "sort": 1,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "series",
              "name": null,
              "show": true,
              "values": [
                "current"
              ]
            },
            "yaxes": [
              {
                "$$hashKey": "object:117",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "$$hashKey": "object:118",
                "format": "short",
                "label": "",
                "logBase": 1,
                "max": null,
                "min": null,
                "show": false
              }
            ],
            "yaxis": {
              "align": false,
              "alignLevel": null
            }
          },
          {
            "cacheTimeout": null,
            "colorBackground": false,
            "colorValue": false,
            "colors": [
              "#299c46",
              "rgba(237, 129, 40, 0.89)",
              "#d44a3a"
            ],
            "datasource": "Loki",
            "fieldConfig": {
              "defaults": {},
              "overrides": []
            },
            "format": "percent",
            "gauge": {
              "maxValue": 100,
              "minValue": 0,
              "show": false,
              "thresholdLabels": false,
              "thresholdMarkers": true
            },
            "gridPos": {
              "h": 5,
              "w": 4,
              "x": 10,
              "y": 0
            },
            "id": 124,
            "interval": null,
            "links": [],
            "mappingType": 1,
            "mappingTypes": [
              {
                "$$hashKey": "object:812",
                "name": "value to text",
                "value": 1
              },
              {
                "$$hashKey": "object:813",
                "name": "range to text",
                "value": 2
              }
            ],
            "maxDataPoints": 100,
            "nullPointMode": "connected",
            "nullText": null,
            "pluginVersion": "6.5.2",
            "postfix": "",
            "postfixFontSize": "50%",
            "prefix": "",
            "prefixFontSize": "50%",
            "rangeMaps": [
              {
                "from": "null",
                "text": "N/A",
                "to": "null"
              }
            ],
            "sparkline": {
              "fillColor": "rgba(87, 148, 242, 0.17)",
              "full": true,
              "lineColor": "rgb(31, 120, 193)",
              "show": true,
              "ymax": null,
              "ymin": null
            },
            "tableColumn": "",
            "targets": [
              {
                "expr": "sum(count_over_time(({stream=~\"std.*\", pod_name!=\"pod\"} |~ \"(?i)error\")[1m])) * 100 / sum(count_over_time(({ stream=~\"std.*\", pod_name!=\"pod\"})[1m]))",
                "refId": "A"
              }
            ],
            "thresholds": "",
            "timeFrom": null,
            "timeShift": null,
            "title": "Error Rate",
            "type": "singlestat",
            "valueFontSize": "70%",
            "valueMaps": [
              {
                "$$hashKey": "object:815",
                "op": "=",
                "text": "N/A",
                "value": "null"
              }
            ],
            "valueName": "current"
          },
          {
            "cacheTimeout": null,
            "colorBackground": false,
            "colorPostfix": true,
            "colorPrefix": false,
            "colorValue": true,
            "colors": [
              "rgb(76, 186, 61)",
              "rgb(76, 186, 61)",
              "rgb(76, 186, 61)"
            ],
            "datasource": "Loki",
            "description": "Total Count: of $searchable_pattern in the specified time range",
            "fieldConfig": {
              "defaults": {},
              "overrides": []
            },
            "format": "short",
            "gauge": {
              "maxValue": 100,
              "minValue": 0,
              "show": false,
              "thresholdLabels": false,
              "thresholdMarkers": true
            },
            "gridPos": {
              "h": 5,
              "w": 3,
              "x": 14,
              "y": 0
            },
            "id": 139,
            "interval": null,
            "links": [],
            "mappingType": 1,
            "mappingTypes": [
              {
                "$$hashKey": "object:1630",
                "name": "value to text",
                "value": 1
              },
              {
                "$$hashKey": "object:1631",
                "name": "range to text",
                "value": 2
              }
            ],
            "maxDataPoints": 100,
            "nullPointMode": "connected",
            "nullText": null,
            "pluginVersion": "6.4.3",
            "postfix": "",
            "postfixFontSize": "50%",
            "prefix": "",
            "prefixFontSize": "50%",
            "rangeMaps": [
              {
                "from": "null",
                "text": "N/A",
                "to": "null"
              }
            ],
            "sparkline": {
              "fillColor": "#96D98D",
              "full": false,
              "lineColor": "rgb(76, 186, 61)",
              "show": true,
              "ymax": null,
              "ymin": null
            },
            "tableColumn": "",
            "targets": [
              {
                "expr": "sum(count_over_time(({stream=~\".*\", pod!=\"pod\"})[1m]))",
                "hide": false,
                "refId": "A"
              }
            ],
            "thresholds": "10,50",
            "timeFrom": null,
            "timeShift": null,
            "title": "Log Count",
            "type": "singlestat",
            "valueFontSize": "70%",
            "valueMaps": [
              {
                "$$hashKey": "object:1633",
                "op": "=",
                "text": "0",
                "value": "null"
              }
            ],
            "valueName": "total"
          },
          {
            "cacheTimeout": null,
            "colorBackground": false,
            "colorPostfix": true,
            "colorPrefix": false,
            "colorValue": true,
            "colors": [
              "rgb(222, 15, 43)",
              "rgb(222, 15, 43)",
              "rgb(222, 15, 43)"
            ],
            "datasource": "Loki",
            "description": "Total Count: of $searchable_pattern in the specified time range",
            "fieldConfig": {
              "defaults": {},
              "overrides": []
            },
            "format": "short",
            "gauge": {
              "maxValue": 100,
              "minValue": 0,
              "show": false,
              "thresholdLabels": false,
              "thresholdMarkers": true
            },
            "gridPos": {
              "h": 5,
              "w": 3,
              "x": 17,
              "y": 0
            },
            "id": 138,
            "interval": null,
            "links": [],
            "mappingType": 1,
            "mappingTypes": [
              {
                "$$hashKey": "object:1630",
                "name": "value to text",
                "value": 1
              },
              {
                "$$hashKey": "object:1631",
                "name": "range to text",
                "value": 2
              }
            ],
            "maxDataPoints": 100,
            "nullPointMode": "connected",
            "nullText": null,
            "pluginVersion": "6.4.3",
            "postfix": "",
            "postfixFontSize": "50%",
            "prefix": "",
            "prefixFontSize": "50%",
            "rangeMaps": [
              {
                "from": "null",
                "text": "N/A",
                "to": "null"
              }
            ],
            "sparkline": {
              "fillColor": "rgb(105, 34, 43)",
              "full": false,
              "lineColor": "#C4162A",
              "show": true,
              "ymax": null,
              "ymin": null
            },
            "tableColumn": "",
            "targets": [
              {
                "expr": "sum(count_over_time(({stream=~\"std.*\", pod_name!=\"pod\"} |~ \"(?i)error\")[1m]))",
                "hide": false,
                "refId": "A"
              }
            ],
            "thresholds": "10,50",
            "timeFrom": null,
            "timeShift": null,
            "title": "Error Count",
            "type": "singlestat",
            "valueFontSize": "70%",
            "valueMaps": [
              {
                "$$hashKey": "object:1633",
                "op": "=",
                "text": "0",
                "value": "null"
              }
            ],
            "valueName": "total"
          },
          {
            "cacheTimeout": null,
            "colorBackground": false,
            "colorValue": false,
            "colors": [
              "#299c46",
              "rgba(237, 129, 40, 0.89)",
              "#d44a3a"
            ],
            "datasource": "Loki",
            "fieldConfig": {
              "defaults": {},
              "overrides": []
            },
            "format": "percent",
            "gauge": {
              "maxValue": 100,
              "minValue": 0,
              "show": false,
              "thresholdLabels": false,
              "thresholdMarkers": true
            },
            "gridPos": {
              "h": 5,
              "w": 4,
              "x": 20,
              "y": 0
            },
            "id": 128,
            "interval": null,
            "links": [],
            "mappingType": 1,
            "mappingTypes": [
              {
                "$$hashKey": "object:812",
                "name": "value to text",
                "value": 1
              },
              {
                "$$hashKey": "object:813",
                "name": "range to text",
                "value": 2
              }
            ],
            "maxDataPoints": 100,
            "nullPointMode": "connected",
            "nullText": null,
            "pluginVersion": "6.5.2",
            "postfix": "",
            "postfixFontSize": "50%",
            "prefix": "",
            "prefixFontSize": "50%",
            "rangeMaps": [
              {
                "from": "null",
                "text": "N/A",
                "to": "null"
              }
            ],
            "sparkline": {
              "fillColor": "rgba(87, 148, 242, 0.17)",
              "full": true,
              "lineColor": "rgb(31, 120, 193)",
              "show": true,
              "ymax": null,
              "ymin": null
            },
            "tableColumn": "",
            "targets": [
              {
                "expr": "sum(count_over_time(({stream=~\"std.*\", pod_name!=\"pod\"} |~ \"(?i)warn\")[1m])) * 100 / sum(count_over_time(({ stream=~\"std.*\", pod_name!=\"pod\"})[1m]))",
                "refId": "A"
              }
            ],
            "thresholds": "",
            "timeFrom": null,
            "timeShift": null,
            "title": "Warn Rate",
            "type": "singlestat",
            "valueFontSize": "70%",
            "valueMaps": [
              {
                "$$hashKey": "object:815",
                "op": "=",
                "text": "N/A",
                "value": "null"
              }
            ],
            "valueName": "current"
          },
          {
            "datasource": "Loki",
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "light-green",
                      "value": null
                    },
                    {
                      "color": "orange",
                      "value": 80
                    }
                  ]
                }
              },
              "overrides": []
            },
            "gridPos": {
              "h": 10,
              "w": 13,
              "x": 0,
              "y": 5
            },
            "hideTimeOverride": false,
            "id": 113,
            "links": [],
            "maxDataPoints": 40,
            "options": {
              "displayMode": "lcd",
              "orientation": "horizontal",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "showUnfilled": true,
              "text": {
                "valueSize": 16
              }
            },
            "pluginVersion": "",
            "targets": [
              {
                "expr": "topk(5,sum(count_over_time({namespace!=\"kube-system\"}[1m]))by (pod)) > 20",
                "instant": false,
                "legendFormat": "{{`{{pod}}`}}",
                "range": true,
                "refId": "A"
              }
            ],
            "timeFrom": null,
            "timeShift": null,
            "title": "Logs/minute ",
            "type": "bargauge"
          },
          {
            "aliasColors": {},
            "bars": false,
            "dashLength": 10,
            "dashes": false,
            "datasource": "Loki",
            "fieldConfig": {
              "defaults": {},
              "overrides": []
            },
            "fill": 1,
            "fillGradient": 0,
            "gridPos": {
              "h": 7,
              "w": 11,
              "x": 13,
              "y": 5
            },
            "hiddenSeries": false,
            "hideTimeOverride": false,
            "id": 114,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": false,
              "total": false,
              "values": false
            },
            "lines": true,
            "linewidth": 1,
            "links": [],
            "nullPointMode": "null",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "",
            "pointradius": 2,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "expr": "sum(count_over_time({namespace!=\"kube-system\"}[1m]))",
                "instant": false,
                "legendFormat": "sum",
                "range": true,
                "refId": "A"
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeRegions": [],
            "timeShift": null,
            "title": "Total Logs/minute",
            "tooltip": {
              "shared": true,
              "sort": 0,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "time",
              "name": null,
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "$$hashKey": "object:701",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "$$hashKey": "object:702",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              }
            ],
            "yaxis": {
              "align": false,
              "alignLevel": null
            }
          },
          {
            "aliasColors": {},
            "bars": false,
            "dashLength": 10,
            "dashes": false,
            "datasource": "Prometheus",
            "description": "",
            "fieldConfig": {
              "defaults": {
                "unit": "short"
              },
              "overrides": []
            },
            "fill": 2,
            "fillGradient": 0,
            "gridPos": {
              "h": 7,
              "w": 11,
              "x": 13,
              "y": 12
            },
            "hiddenSeries": false,
            "id": 122,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": true,
              "total": false,
              "values": false
            },
            "lines": true,
            "linewidth": 2,
            "nullPointMode": "null",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "",
            "pointradius": 2,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "exemplar": true,
                "expr": "rate(loki_distributor_lines_received_total[1m])",
                "interval": "",
                "legendFormat": "log entries",
                "refId": "A"
              },
              {
                "exemplar": true,
                "expr": "sum(rate(loki_distributor_bytes_received_total[1m]))",
                "hide": false,
                "interval": "",
                "legendFormat": "bytes ",
                "refId": "B"
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeRegions": [],
            "timeShift": null,
            "title": "Loki (distributor)",
            "tooltip": {
              "shared": true,
              "sort": 0,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "time",
              "name": null,
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "$$hashKey": "object:1456",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "$$hashKey": "object:1457",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              }
            ],
            "yaxis": {
              "align": false,
              "alignLevel": null
            }
          },
          {
            "aliasColors": {},
            "bars": true,
            "cacheTimeout": null,
            "dashLength": 10,
            "dashes": false,
            "datasource": "Loki",
            "decimals": 0,
            "fieldConfig": {
              "defaults": {
                "links": []
              },
              "overrides": []
            },
            "fill": 1,
            "fillGradient": 1,
            "gridPos": {
              "h": 11,
              "w": 13,
              "x": 0,
              "y": 15
            },
            "hiddenSeries": false,
            "id": 132,
            "interval": "1m",
            "legend": {
              "alignAsTable": true,
              "avg": false,
              "current": true,
              "hideEmpty": false,
              "hideZero": false,
              "max": false,
              "min": false,
              "rightSide": false,
              "show": true,
              "sort": "current",
              "sortDesc": true,
              "total": false,
              "values": true
            },
            "lines": false,
            "linewidth": 3,
            "links": [],
            "maxDataPoints": 40,
            "nullPointMode": "null",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "",
            "pointradius": 2,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "expr": "sum(count_over_time(({pod_name!=\"pod\", stream=~\"std.*\"} |~ \"(?i)error\")[$__interval])) by (pod)",
                "legendFormat": "{{`{{pod}}`}}",
                "maxLines": 0,
                "refId": "A"
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeRegions": [],
            "timeShift": null,
            "title": "Errors/Pod (historical)",
            "tooltip": {
              "shared": true,
              "sort": 2,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "time",
              "name": null,
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "$$hashKey": "object:425",
                "decimals": 0,
                "format": "short",
                "label": "Count",
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "$$hashKey": "object:426",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": false
              }
            ],
            "yaxis": {
              "align": false,
              "alignLevel": null
            }
          },
          {
            "aliasColors": {},
            "bars": false,
            "cacheTimeout": null,
            "dashLength": 10,
            "dashes": false,
            "datasource": "Loki",
            "fieldConfig": {
              "defaults": {
                "links": []
              },
              "overrides": []
            },
            "fill": 1,
            "fillGradient": 10,
            "gridPos": {
              "h": 7,
              "w": 11,
              "x": 13,
              "y": 19
            },
            "hiddenSeries": false,
            "id": 134,
            "interval": null,
            "legend": {
              "alignAsTable": true,
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "rightSide": false,
              "show": true,
              "total": false,
              "values": false
            },
            "lines": true,
            "linewidth": 1,
            "links": [],
            "maxDataPoints": 100,
            "nullPointMode": "null",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "",
            "pointradius": 0.5,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "expr": "sum(rate(({stream=~\"std.*\", pod_name!=\"pod\"} |~ \"(?i)error\")[30s])) by (pod_name)",
                "hide": false,
                "legendFormat": "Average over pods",
                "refId": "A"
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeRegions": [],
            "timeShift": null,
            "title": "Error Rate ",
            "tooltip": {
              "shared": true,
              "sort": 2,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "time",
              "name": null,
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "$$hashKey": "object:2804",
                "format": "short",
                "label": null,
                "logBase": 10,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "$$hashKey": "object:2805",
                "format": "short",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              }
            ],
            "yaxis": {
              "align": false,
              "alignLevel": null
            }
          },
          {
            "collapsed": true,
            "datasource": null,
            "gridPos": {
              "h": 1,
              "w": 24,
              "x": 0,
              "y": 26
            },
            "id": 110,
            "panels": [
              {
                "datasource": "Loki",
                "description": "Live logs is a like 'tail -f' in a real time",
                "fieldConfig": {
                  "defaults": {},
                  "overrides": []
                },
                "gridPos": {
                  "h": 9,
                  "w": 24,
                  "x": 0,
                  "y": 26
                },
                "id": 136,
                "options": {
                  "dedupStrategy": "none",
                  "showLabels": true,
                  "showTime": false,
                  "sortOrder": "Descending",
                  "wrapLogMessage": false
                },
                "targets": [
                  {
                    "expr": "{pod_name!=\"pod\", stream=~\"std.*\"} |~ \"(?i)error\" ",
                    "hide": false,
                    "refId": "A"
                  }
                ],
                "timeFrom": null,
                "timeShift": null,
                "title": "Live logs",
                "type": "logs"
              }
            ],
            "title": "Logs",
            "type": "row"
          }
        ],
        "refresh": "10s",
        "schemaVersion": 27,
        "style": "dark",
        "tags": [
          "kyma",
          "logging"
        ],
        "templating": {
          "list": [
            {
              "allValue": null,
              "current": {
                "selected": false,
                "text": "kyma-system",
                "value": "kyma-system"
              },
              "datasource": "Prometheus",
              "definition": "label_values(kube_pod_container_info{image=~\".*loki.*\", container!=\"loki-canary\"}, namespace)",
              "description": null,
              "error": null,
              "hide": 0,
              "includeAll": false,
              "label": null,
              "multi": false,
              "name": "namespace",
              "options": [],
              "query": {
                "query": "label_values(kube_pod_container_info{image=~\".*loki.*\", container!=\"loki-canary\"}, namespace)",
                "refId": "Prometheus-namespace-Variable-Query"
              },
              "refresh": 1,
              "regex": "",
              "skipUrlSync": false,
              "sort": 0,
              "tagValuesQuery": "",
              "tags": [],
              "tagsQuery": "",
              "type": "query",
              "useTags": false
            }
          ]
        },
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": [
            "10s",
            "30s",
            "1m",
            "5m",
            "15m",
            "30m",
            "1h",
            "2h",
            "1d"
          ]
        },
        "timezone": "",
        "title": "Kyma / Logging / Logs / Stats",
        "uid": "lokidashboardstats",
        "version": 1
      }